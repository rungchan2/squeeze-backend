-- =====================================================
-- Sqeeze LMS Posts ÌÖåÏù¥Î∏î ÏïàÏ†ÑÌïú ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò Ï†ÑÎûµ
-- =====================================================

-- üìä ÌòÑÏû¨ ÏÉÅÌô© Î∂ÑÏÑù:
-- - posts ÌÖåÏù¥Î∏î: 575Í∞ú Î†àÏΩîÎìú
-- - Î™®Îì† postÏóê content Ï°¥Ïû¨ (HTML ÌòïÌÉú)
-- - mission_type: ÌòÑÏû¨ "text" ÌÉÄÏûÖÎßå ÏÇ¨Ïö©
-- - ÌååÏùº ÏóÖÎ°úÎìú ÏóÜÏùå (file_url Î™®Îëê null)
-- - ÌåÄ Ï†úÏ∂úÎ¨º: 2Í∞úÎßå Ï°¥Ïû¨

-- =====================================================
-- 1Îã®Í≥Ñ: Î∞±ÏóÖ Î∞è Ï§ÄÎπÑ ÏûëÏóÖ
-- =====================================================

-- 1-1. Ï†ÑÏ≤¥ ÌÖåÏù¥Î∏î Î∞±ÏóÖ ÏÉùÏÑ±
CREATE TABLE posts_backup_20250726 AS 
SELECT * FROM posts;

-- 1-2. ÏùòÏ°¥ÏÑ± ÌÖåÏù¥Î∏î Î∞±ÏóÖ
CREATE TABLE user_points_backup_20250726 AS 
SELECT * FROM user_points;

CREATE TABLE team_points_backup_20250726 AS 
SELECT * FROM team_points;

CREATE TABLE comments_backup_20250726 AS 
SELECT * FROM comments;

CREATE TABLE likes_backup_20250726 AS 
SELECT * FROM likes;

-- 1-3. missions ÌÖåÏù¥Î∏î ÌòÑÏû¨ mission_type Í∞í ÌôïÏù∏
-- (ÌòÑÏû¨ "text"Î°ú ÎêòÏñ¥ ÏûàÏúºÎÇò ÏÉàÎ°úÏö¥ ENUMÏúºÎ°ú Î≥ÄÍ≤Ω ÌïÑÏöî)
SELECT DISTINCT mission_type FROM missions;

-- =====================================================
-- 2Îã®Í≥Ñ: ÏÉàÎ°úÏö¥ ENUM Î∞è Íµ¨Ï°∞ ÏÉùÏÑ±
-- =====================================================

-- 2-1. mission_type ENUM ÏÉùÏÑ±
CREATE TYPE mission_type AS ENUM (
    'essay',           -- Ï£ºÍ¥ÄÏãù (Í∏∞Ï°¥ text ÌÉÄÏûÖ)
    'multiple_choice', -- Í∞ùÍ¥ÄÏãù
    'image_upload',    -- Ïù¥ÎØ∏ÏßÄ Ï†úÏ∂ú
    'mixed'            -- Î≥µÌï©Ìòï
);

-- 2-2. Mission Questions ÌÖåÏù¥Î∏î ÏÉùÏÑ±
CREATE TABLE mission_questions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    mission_id UUID NOT NULL,
    question_text TEXT NOT NULL,
    question_type mission_type NOT NULL DEFAULT 'essay',
    question_order INTEGER NOT NULL DEFAULT 1,
    
    -- Í∞ùÍ¥ÄÏãù Í¥ÄÎ†® ÌïÑÎìú
    options JSONB, -- Í∞ùÍ¥ÄÏãù ÏÑ†ÌÉùÏßÄ
    correct_answer TEXT, -- Ï†ïÎãµ
    
    -- Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìú Í¥ÄÎ†® ÌïÑÎìú
    max_images INTEGER DEFAULT 1,
    required_image BOOLEAN DEFAULT false,
    
    -- Í≥µÌÜµ ÌïÑÎìú
    is_required BOOLEAN DEFAULT true,
    max_characters INTEGER,
    placeholder_text TEXT,
    points INTEGER DEFAULT 0,
    
    created_at TIMESTAMPTZ DEFAULT now(),
    updated_at TIMESTAMPTZ DEFAULT now(),
    
    FOREIGN KEY (mission_id) REFERENCES missions(id) ON DELETE CASCADE
);

-- RLS ÌôúÏÑ±Ìôî
ALTER TABLE mission_questions ENABLE ROW LEVEL SECURITY;

-- Ïù∏Îç±Ïä§ ÏÉùÏÑ±
CREATE INDEX idx_mission_questions_mission_id ON mission_questions(mission_id);
CREATE INDEX idx_mission_questions_order ON mission_questions(question_order);

-- =====================================================
-- 3Îã®Í≥Ñ: Posts ÌÖåÏù¥Î∏î Ï†êÏßÑÏ†Å Î≥ÄÍ≤Ω
-- =====================================================

-- 3-1. ÏÉàÎ°úÏö¥ Ïª¨ÎüºÎì§ Ï∂îÍ∞Ä (NULL ÌóàÏö©ÏúºÎ°ú ÏãúÏûë)
ALTER TABLE posts 
ADD COLUMN IF NOT EXISTS answers_data JSONB,
ADD COLUMN IF NOT EXISTS auto_score INTEGER DEFAULT 0,
ADD COLUMN IF NOT EXISTS manual_score INTEGER DEFAULT 0,
ADD COLUMN IF NOT EXISTS total_questions INTEGER DEFAULT 1,
ADD COLUMN IF NOT EXISTS answered_questions INTEGER DEFAULT 1,
ADD COLUMN IF NOT EXISTS completion_rate DECIMAL(5,2) DEFAULT 100.00;

-- 3-2. Ïù∏Îç±Ïä§ Ï∂îÍ∞Ä
CREATE INDEX idx_posts_answers_data ON posts USING GIN (answers_data);

-- =====================================================
-- 4Îã®Í≥Ñ: Îç∞Ïù¥ÌÑ∞ ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò Ìï®Ïàò ÏÉùÏÑ±
-- =====================================================

-- 4-1. Í∏∞Ï°¥ missions Îç∞Ïù¥ÌÑ∞Î•º ÏúÑÌïú Í∏∞Î≥∏ ÏßàÎ¨∏ ÏÉùÏÑ± Ìï®Ïàò
CREATE OR REPLACE FUNCTION create_default_questions_for_existing_missions()
RETURNS void AS $$
DECLARE
    mission_record RECORD;
    question_id UUID;
BEGIN
    -- Í∏∞Ï°¥ Î™®Îì† missionsÏóê ÎåÄÌï¥ Í∏∞Î≥∏ ÏßàÎ¨∏ ÏÉùÏÑ±
    FOR mission_record IN 
        SELECT id, name, description, points 
        FROM missions 
        WHERE NOT EXISTS (
            SELECT 1 FROM mission_questions WHERE mission_id = missions.id
        )
    LOOP
        -- Í∞Å ÎØ∏ÏÖòÏóê ÎåÄÌï¥ Í∏∞Î≥∏ Ï£ºÍ¥ÄÏãù ÏßàÎ¨∏ ÏÉùÏÑ±
        INSERT INTO mission_questions (
            mission_id, 
            question_text, 
            question_type, 
            question_order, 
            max_characters,
            points,
            is_required
        ) VALUES (
            mission_record.id,
            COALESCE(mission_record.description, mission_record.name),
            'essay',
            1,
            5000, -- Ï∂©Î∂ÑÌïú Í∏ÄÏûê Ïàò
            COALESCE(mission_record.points, 0),
            true
        ) RETURNING id INTO question_id;
        
        RAISE NOTICE 'Created default question for mission: %', mission_record.name;
    END LOOP;
END;
$$ LANGUAGE plpgsql;

-- 4-2. Posts Îç∞Ïù¥ÌÑ∞ ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò Ìï®Ïàò
CREATE OR REPLACE FUNCTION migrate_posts_to_new_structure()
RETURNS void AS $$
DECLARE
    post_record RECORD;
    question_id UUID;
    migration_count INTEGER := 0;
BEGIN
    -- Í∏∞Ï°¥ posts Îç∞Ïù¥ÌÑ∞Î•º ÏÉà Íµ¨Ï°∞Î°ú Î≥ÄÌôò
    FOR post_record IN 
        SELECT id, content, mission_instance_id, score, created_at, updated_at
        FROM posts 
        WHERE answers_data IS NULL
        ORDER BY created_at
    LOOP
        -- Ìï¥Îãπ ÎØ∏ÏÖòÏùò Ï≤´ Î≤àÏß∏ ÏßàÎ¨∏ ID Ï∞æÍ∏∞
        SELECT mq.id INTO question_id
        FROM journey_mission_instances jmi
        JOIN mission_questions mq ON jmi.mission_id = mq.mission_id
        WHERE jmi.id = post_record.mission_instance_id
        ORDER BY mq.question_order
        LIMIT 1;
        
        -- answers_data JSON Íµ¨Ï°∞ ÏÉùÏÑ±
        UPDATE posts 
        SET 
            answers_data = jsonb_build_object(
                'answers', jsonb_build_array(
                    jsonb_build_object(
                        'question_id', question_id,
                        'question_order', 1,
                        'answer_type', 'essay',
                        'answer_text', post_record.content,
                        'selected_option', null,
                        'image_urls', ARRAY[]::text[],
                        'is_correct', null,
                        'points_earned', COALESCE(post_record.score, 0)
                    )
                ),
                'submission_metadata', jsonb_build_object(
                    'total_questions', 1,
                    'answered_questions', CASE 
                        WHEN post_record.content IS NOT NULL AND post_record.content != '' THEN 1 
                        ELSE 0 
                    END,
                    'submission_time', post_record.created_at,
                    'last_modified', post_record.updated_at
                )
            ),
            manual_score = COALESCE(post_record.score, 0),
            total_questions = 1,
            answered_questions = CASE 
                WHEN post_record.content IS NOT NULL AND post_record.content != '' THEN 1 
                ELSE 0 
            END,
            completion_rate = CASE 
                WHEN post_record.content IS NOT NULL AND post_record.content != '' THEN 100.00 
                ELSE 0.00 
            END
        WHERE id = post_record.id;
        
        migration_count := migration_count + 1;
        
        -- ÏßÑÌñâ ÏÉÅÌô© Î°úÍ∑∏ (100Í∞úÎßàÎã§)
        IF migration_count % 100 = 0 THEN
            RAISE NOTICE 'Migrated % posts', migration_count;
        END IF;
    END LOOP;
    
    RAISE NOTICE 'Migration completed. Total posts migrated: %', migration_count;
END;
$$ LANGUAGE plpgsql;

-- 4-3. missions ÌÖåÏù¥Î∏î mission_type ÏóÖÎç∞Ïù¥Ìä∏ Ìï®Ïàò
CREATE OR REPLACE FUNCTION update_missions_type()
RETURNS void AS $$
BEGIN
    -- Í∏∞Ï°¥ "text" ÌÉÄÏûÖÏùÑ "essay"Î°ú Î≥ÄÍ≤Ω
    UPDATE missions 
    SET mission_type = 'essay'::text 
    WHERE mission_type = 'text';
    
    -- mission_type Ïª¨ÎüºÏùÑ ENUMÏúºÎ°ú Î≥ÄÍ≤Ω
    ALTER TABLE missions 
    ALTER COLUMN mission_type TYPE mission_type 
    USING CASE 
        WHEN mission_type = 'text' THEN 'essay'::mission_type
        ELSE 'essay'::mission_type
    END;
    
    -- Í∏∞Î≥∏Í∞í ÏÑ§Ï†ï
    ALTER TABLE missions 
    ALTER COLUMN mission_type SET DEFAULT 'essay';
    
    RAISE NOTICE 'missions.mission_type updated to ENUM';
END;
$$ LANGUAGE plpgsql;

-- =====================================================
-- 5Îã®Í≥Ñ: Í≤ÄÏ¶ù Ìï®ÏàòÎì§
-- =====================================================

-- 5-1. ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò Í≤ÄÏ¶ù Ìï®Ïàò
CREATE OR REPLACE FUNCTION validate_migration()
RETURNS TABLE (
    check_name TEXT,
    status TEXT,
    details TEXT
) AS $$
BEGIN
    -- 1. Ï†ÑÏ≤¥ post Ïàò ÌôïÏù∏
    RETURN QUERY
    SELECT 
        'Post Count Check'::TEXT,
        CASE 
            WHEN (SELECT COUNT(*) FROM posts) = (SELECT COUNT(*) FROM posts_backup_20250726)
            THEN 'PASS'::TEXT
            ELSE 'FAIL'::TEXT
        END,
        format('Original: %s, Current: %s', 
            (SELECT COUNT(*) FROM posts_backup_20250726),
            (SELECT COUNT(*) FROM posts)
        );
    
    -- 2. answers_data ÏÉùÏÑ± ÌôïÏù∏
    RETURN QUERY
    SELECT 
        'Answers Data Check'::TEXT,
        CASE 
            WHEN (SELECT COUNT(*) FROM posts WHERE answers_data IS NOT NULL) = (SELECT COUNT(*) FROM posts)
            THEN 'PASS'::TEXT
            ELSE 'FAIL'::TEXT
        END,
        format('Posts with answers_data: %s / %s', 
            (SELECT COUNT(*) FROM posts WHERE answers_data IS NOT NULL),
            (SELECT COUNT(*) FROM posts)
        );
    
    -- 3. Í∏∞Î≥∏ ÏßàÎ¨∏ ÏÉùÏÑ± ÌôïÏù∏
    RETURN QUERY
    SELECT 
        'Mission Questions Check'::TEXT,
        CASE 
            WHEN (SELECT COUNT(*) FROM mission_questions) >= (SELECT COUNT(*) FROM missions)
            THEN 'PASS'::TEXT
            ELSE 'FAIL'::TEXT
        END,
        format('Questions: %s, Missions: %s', 
            (SELECT COUNT(*) FROM mission_questions),
            (SELECT COUNT(*) FROM missions)
        );
    
    -- 4. Ï†êÏàò Îç∞Ïù¥ÌÑ∞ ÏùºÍ¥ÄÏÑ± ÌôïÏù∏
    RETURN QUERY
    SELECT 
        'Score Consistency Check'::TEXT,
        CASE 
            WHEN (
                SELECT COUNT(*) FROM posts p1 
                JOIN posts_backup_20250726 p2 ON p1.id = p2.id 
                WHERE COALESCE(p1.score, 0) != COALESCE(p2.score, 0)
            ) = 0
            THEN 'PASS'::TEXT
            ELSE 'FAIL'::TEXT
        END,
        'Score data consistency between original and migrated';
END;
$$ LANGUAGE plpgsql;

-- 5-2. ÏÉòÌîå Îç∞Ïù¥ÌÑ∞ Ï°∞Ìöå Ìï®Ïàò
CREATE OR REPLACE FUNCTION get_migration_samples(sample_count INTEGER DEFAULT 5)
RETURNS TABLE (
    post_id UUID,
    original_content TEXT,
    new_answers_data JSONB,
    original_score INTEGER,
    new_manual_score INTEGER
) AS $$
BEGIN
    RETURN QUERY
    SELECT 
        p.id,
        LEFT(pb.content, 100),
        p.answers_data,
        pb.score,
        p.manual_score
    FROM posts p
    JOIN posts_backup_20250726 pb ON p.id = pb.id
    ORDER BY p.created_at DESC
    LIMIT sample_count;
END;
$$ LANGUAGE plpgsql;

-- =====================================================
-- 6Îã®Í≥Ñ: Ïã§Ìñâ Ïä§ÌÅ¨Î¶ΩÌä∏ (ÏàúÏÑúÎåÄÎ°ú Ïã§Ìñâ)
-- =====================================================

-- Ïã§Ìñâ ÏàúÏÑú:
/*
1. Î∞±ÏóÖ ÏÉùÏÑ±
   SELECT 'Backup created' as step;

2. Í∏∞Î≥∏ ÏßàÎ¨∏ ÏÉùÏÑ±
   SELECT create_default_questions_for_existing_missions();

3. missions ÌÖåÏù¥Î∏î ÌÉÄÏûÖ ÏóÖÎç∞Ïù¥Ìä∏
   SELECT update_missions_type();

4. posts Îç∞Ïù¥ÌÑ∞ ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò
   SELECT migrate_posts_to_new_structure();

5. Í≤ÄÏ¶ù Ïã§Ìñâ
   SELECT * FROM validate_migration();

6. ÏÉòÌîå ÌôïÏù∏
   SELECT * FROM get_migration_samples(10);
*/

-- =====================================================
-- 7Îã®Í≥Ñ: Î°§Î∞± Ïä§ÌÅ¨Î¶ΩÌä∏ (Î¨∏Ï†ú Î∞úÏÉù Ïãú ÏÇ¨Ïö©)
-- =====================================================

CREATE OR REPLACE FUNCTION rollback_migration()
RETURNS void AS $$
BEGIN
    -- posts ÌÖåÏù¥Î∏î Î≥µÏõê
    DROP TABLE IF EXISTS posts;
    CREATE TABLE posts AS SELECT * FROM posts_backup_20250726;
    
    -- Í∏∞Î≥∏ÌÇ§ Î≥µÏõê
    ALTER TABLE posts ADD PRIMARY KEY (id);
    
    -- Ïô∏ÎûòÌÇ§ Î≥µÏõê
    ALTER TABLE posts ADD CONSTRAINT posts_user_id_fkey 
        FOREIGN KEY (user_id) REFERENCES profiles(id);
    ALTER TABLE posts ADD CONSTRAINT posts_mission_instance_id_fkey 
        FOREIGN KEY (mission_instance_id) REFERENCES journey_mission_instances(id);
    
    -- ÏÉà ÌÖåÏù¥Î∏îÎì§ Ï†úÍ±∞
    DROP TABLE IF EXISTS mission_questions;
    DROP TYPE IF EXISTS mission_type;
    
    RAISE NOTICE 'Rollback completed';
END;
$$ LANGUAGE plpgsql;

-- =====================================================
-- 8Îã®Í≥Ñ: Ï†ïÎ¶¨ Ïä§ÌÅ¨Î¶ΩÌä∏ (ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò ÏôÑÎ£å ÌõÑ Ïã§Ìñâ)
-- =====================================================

CREATE OR REPLACE FUNCTION cleanup_migration()
RETURNS void AS $$
BEGIN
    -- content Ïª¨Îüº Ï†úÍ±∞ (ÏÑ†ÌÉùÏÇ¨Ìï≠ - Ïã†Ï§ëÌïòÍ≤å Í≤∞Ï†ï)
    -- ALTER TABLE posts DROP COLUMN content;
    
    -- Î∞±ÏóÖ ÌÖåÏù¥Î∏î Ï†úÍ±∞ (Ï∂©Î∂ÑÌûà Í≤ÄÏ¶ù ÌõÑ)
    -- DROP TABLE posts_backup_20250726;
    -- DROP TABLE user_points_backup_20250726;
    -- DROP TABLE team_points_backup_20250726;
    -- DROP TABLE comments_backup_20250726;
    -- DROP TABLE likes_backup_20250726;
    
    RAISE NOTICE 'Cleanup completed';
END;
$$ LANGUAGE plpgsql;

-- =====================================================
-- 9Îã®Í≥Ñ: RLS Ï†ïÏ±Ö ÏÉùÏÑ±
-- =====================================================

-- mission_questions RLS Ï†ïÏ±Ö
CREATE POLICY "Users can view mission questions" ON mission_questions
    FOR SELECT USING (true);

CREATE POLICY "Teachers can manage mission questions" ON mission_questions
    FOR ALL USING (
        EXISTS (
            SELECT 1 FROM profiles 
            WHERE id = auth.uid() 
            AND role IN ('teacher', 'admin')
        )
    );

-- =====================================================
-- 10Îã®Í≥Ñ: ÏÑ±Îä• ÏµúÏ†ÅÌôî
-- =====================================================

-- ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
ANALYZE posts;
ANALYZE mission_questions;

-- Ï∂îÍ∞Ä Ïù∏Îç±Ïä§ (ÌïÑÏöîÏãú)
-- CREATE INDEX idx_posts_completion_rate ON posts(completion_rate);
-- CREATE INDEX idx_posts_manual_score ON posts(manual_score);

-- =====================================================
-- ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò Ïã§Ìñâ Ï≤¥ÌÅ¨Î¶¨Ïä§Ìä∏
-- =====================================================

/*
‚ñ° 1. Î∞±ÏóÖ ÏÉùÏÑ± ÏôÑÎ£å
‚ñ° 2. Í∏∞Î≥∏ ÏßàÎ¨∏ ÏÉùÏÑ± ÏôÑÎ£å  
‚ñ° 3. missions ÌÉÄÏûÖ ÏóÖÎç∞Ïù¥Ìä∏ ÏôÑÎ£å
‚ñ° 4. posts ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò ÏôÑÎ£å
‚ñ° 5. Í≤ÄÏ¶ù ÌÜµÍ≥º
‚ñ° 6. ÏÉòÌîå Îç∞Ïù¥ÌÑ∞ ÌôïÏù∏
‚ñ° 7. API ÌÖåÏä§Ìä∏ ÏôÑÎ£å
‚ñ° 8. ÏÇ¨Ïö©Ïûê ÌÖåÏä§Ìä∏ ÏôÑÎ£å
‚ñ° 9. Ï†ïÎ¶¨ ÏûëÏóÖ ÏôÑÎ£å
‚ñ° 10. Î¨∏ÏÑú ÏóÖÎç∞Ïù¥Ìä∏ ÏôÑÎ£å
*/